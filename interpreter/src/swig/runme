#!/bin/bash


echo "This is a minimal demo to compile Tarski as a dynamic library and use it in a Java program natively."
echo "Make sure to run build.sh in the root folder of Tarski first."

set -e

SACLIB=../../../saclib2.2.7
UNAME_S=`uname -s`
START_GROUP="-Wl,--start-group"
END_GROUP="-Wl,--end-group"

REND=../../extensions/rend/rendo.a

if [ "$UNAME_S" = "Darwin" ]; then
 JAVA=`find /usr/local/Cellar/openjdk/*/ | sort | head -1`
 if [ "$JAVA" = "" ]; then
  echo "No Java found. Consider installing it via Homebrew (openjdk)."
  exit 1
  fi
 LIBTARSKI=libtarski.jnilib
 # These are unsupported on Mac:
 START_GROUP=
 END_GROUP=

 which swig > /dev/null || {
   echo "No swig found. Consider installing it via Homebrew (swig)."
   exit 1
 }
 
 fi
 
if [ "$UNAME_S" = "Linux" ]; then
 JAVA=`find /usr/lib/jvm/* | sort | head -1`
 if [ "$JAVA" = "" ]; then
  echo "No Java found. This demo requires a working JDK installation."
  exit 1
  fi
 LIBTARSKI=libtarski.so

 which swig > /dev/null || {
   echo "No swig found. This demo requires it."
   exit 1
   }

 fi

if [[ "$UNAME_S" == *"MINGW"* ]]; then
 JAVA=`find /c/Program\ Files\/OpenJDK/* | sort | head -1`
 if [ "$JAVA" = "" ]; then
  echo "No Java found. Consider installing it via choco (openjdk)."
  exit 1
  fi
 LIBTARSKI=tarski.dll
 REND=
 export qe=..\\..

 which swig > /dev/null || {
   echo "No swig found. Consider installing it via pacman (swig)."
   exit 1
   }

 fi


echo "Java is detected in $JAVA."

swig -c++ -java tarski.i

g++ -c tarski_wrap.cxx -I../main -I.. -I$SACLIB/include \
 -I"$JAVA/include" -I"$JAVA/include/linux" -I"$JAVA/include/win32" -fPIC

cd ../..
# This is tested only on Linux, and not flexible enough. FIXME. (Add this in the main Makefile instead.)
g++ -shared src/swig/tarski_wrap.o ./build/./src/algparse/alglex.cpp.o ./build/./src/algparse/algparse.cpp.o ./build/./src/algparse/getvars.cpp.o ./build/./src/algparse/grammar.tab.cpp.o ./build/./src/algparse/prettyprint.cpp.o ./build/./src/algparse/treemanip.cpp.o ./build/./src/algparse/utils.cpp.o ./build/./src/api/store.cpp.o ./build/./src/bbwb/bbsat-comm.cpp.o ./build/./src/bbwb/bbwb.cpp.o ./build/./src/bbwb/blackbox-solve.cpp.o ./build/./src/bbwb/deduce-sign.cpp.o ./build/./src/bbwb/deduction.cpp.o ./build/./src/bbwb/dmatrix.cpp.o ./build/./src/bbwb/fern-poly-iter.cpp.o ./build/./src/bbwb/matrix-manager.cpp.o ./build/./src/bbwb/minwtbasis.cpp.o ./build/./src/bbwb/mono-explain.cpp.o ./build/./src/bbwb/normal.cpp.o ./build/./src/bbwb/poly-explain.cpp.o ./build/./src/bbwb/simplifier.cpp.o ./build/./src/bbwb/solver-manager.cpp.o ./build/./src/bbwb/wbsat-comm.cpp.o ./build/./src/bbwb/whitebox-solve.cpp.o ./build/./src/formula/DynamicBitVector.cpp.o ./build/./src/formula/formmanip.cpp.o ./build/./src/formula/formula.cpp.o ./build/./src/formula/linearSubs.cpp.o ./build/./src/formula/monomialinequality.cpp.o ./build/./src/formula/normalize.cpp.o ./build/./src/formula/writeForQE.cpp.o ./build/./src/formula/writeForQEPCADB.cpp.o ./build/./src/nucad/NuCADCellType.cpp.o ./build/./src/nucad/TestComm.cpp.o ./build/./src/nucad/checks.cpp.o ./build/./src/nucad/collectivetermbase.cpp.o ./build/./src/nucad/goal.cpp.o ./build/./src/nucad/nucadcell.cpp.o ./build/./src/nucad/property.cpp.o ./build/./src/nucad/prophandler.cpp.o ./build/./src/nucad/samplePointManager.cpp.o ./build/./src/nucad/termbase.cpp.o ./build/./src/nucad/testsamplepointmanager.cpp.o ./build/./src/nucad/treesamplepointmanager.cpp.o ./build/./src/onecell/OCBuilderType.cpp.o ./build/./src/onecell/OpenNuCADType.cpp.o ./build/./src/onecell/builder.cpp.o ./build/./src/onecell/cellbound.cpp.o ./build/./src/onecell/nnet.cpp.o ./build/./src/onecell/opencell.cpp.o ./build/./src/onecell/opennucad.cpp.o ./build/./src/onecell/varorder.cpp.o ./build/./src/poly/CREAD.cpp.o ./build/./src/poly/CWRITE.cpp.o ./build/./src/poly/GCSI.cpp.o ./build/./src/poly/factor.cpp.o ./build/./src/poly/gcword.cpp.o ./build/./src/poly/md5digest.cpp.o ./build/./src/poly/poly.cpp.o ./build/./src/poly/polymanager.cpp.o ./build/./src/poly/sacMod.cpp.o ./build/./src/poly/sacpolyutils.cpp.o ./build/./src/poly/specialDeduction.cpp.o ./build/./src/poly/tracker.cpp.o ./build/./src/poly/variable.cpp.o ./build/./src/realroots/CSSP.c.o ./build/./src/realroots/IPIIS.c.o ./build/./src/realroots/RealAlgNumType.cpp.o ./build/./src/realroots/realroots.cpp.o ./build/./src/search/clearAssignments-comm.cpp.o ./build/./src/search/clearAssignments.cpp.o ./build/./src/search/grade.cpp.o ./build/./src/search/graph.cpp.o ./build/./src/search/qfr.cpp.o ./build/./src/search/rewrite.cpp.o ./build/./src/search/search.cpp.o ./build/./src/shell/einterpreter.cpp.o ./build/./src/shell/qepcad-inter/qepcad-api.cpp.o ./build/./src/shell/schemish.cpp.o ./build/./src/shell/shell.cpp.o ./build/./src/shell/utils.cpp.o ./build/./src/smtlib/readSMTRetFormula.cpp.o ./build/./src/smtsolver/box-solver-comm.cpp.o ./build/./src/smtsolver/box-solver.cpp.o ./build/./src/smtsolver/formula-maker.cpp.o ./build/./src/smtsolver/mhs-gen.cpp.o ./build/./src/smtsolver/minhitset/naive/hitset.cpp.o ./build/./src/smtsolver/qep-solver-comm.cpp.o ./build/./src/smtsolver/qep-solver.cpp.o -o $LIBTARSKI ../qesource/source/saclib/IPPSCT.o ../qesource/source/saclib/IPFZT1.o ../qesource/source/saclib/IPRNEVAL.o ../qesource/source/saclib/RVSPTSVSP.o ../qesource/source/saclib/FAIL.o ../qesource/source/saclib/SOSRSUPS.o ../qesource/source/saclib/SUBSET.o ../qesource/source/saclib/IPFZT.o ../qesource/source/saclib/SOSRSUBS.o ../qesource/source/qepcad.a ../qesource/extensions/sfext/sfexto.a ../qesource/extensions/lift2D/lift2Do.a ../qesource/extensions/adj2d/adj2do.a ../qesource/extensions/sfext/sfexto.a ../qesource/source/qepcad.a ../qesource/extensions/rend/rendo.a -lreadline ../saclib2.2.7/lib/saclibo.a ../minisat/core/lib.a -lssl  -lcrypto -lrt -lpthread -ltinfo -fPIC
cp $LIBTARSKI src/swig
cd src/swig

"$JAVA/bin/javac" main.java

"$JAVA/bin/java" -Djava.library.path=. main
